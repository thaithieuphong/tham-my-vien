<link rel="stylesheet" href="/css/root.css">
<link rel="stylesheet" href="/css/assistant.css">
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasWithBackdrop"
    aria-labelledby="offcanvasWithBackdropLabel">
    <div class="offcanvas-header bg-dark border-bottom">
        <h5 class="offcanvas-title text-white" id="offcanvasWithBackdropLabel">BẢNG ĐIỀU KHIỂN</h5>
        <button type="button" class="btn-close text-reset btn-light" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body container-sidebar bg-dark">
        <div class="sidebar-item">
            <a href="/operating-room/nursing" class="sidebar-item-title pl-3">
                <i class="ti-receipt mr-3"></i>Phiếu hoàn thành
            </a>
        </div>
		<div class="sidebar-item">
            <a href="/operating-room/nursing/service-note" class="sidebar-item-title pl-3">
                <i class="ti-user mr-3"></i>Phiếu phẩu thuật
            </a>
        </div>
		<div class="sidebar-item">
            <a href="/operating-room/nursing/re-examination" class="sidebar-item-title pl-3">
                <i class="ti-user mr-3"></i>Phiếu tái khám
            </a>
        </div>
    </div>
	<div class="offcanvas-footer bg-dark border-top">
        <div class="sidebar-item">
            <a href="/operating-room/nursing/profile" class="sidebar-item-title pl-3">
                <i class="ti-user mr-3"></i>Thông tin người dùng
            </a>
        </div>
		<div class="sidebar-item">
			<form method="POST" action="/logout">
				<button href="/logout" class="btn btn-danger logout-btn" type="submit">Đăng xuất</>
			</form>
		</div>
    </div>
</div>
<div class="sticky-top">
    <nav class="navbar navbar-light bg-dark">
        <div class="img-container">
        </div>
        <div class="text-light text-uppercase fw-bold">
            {{this.title}}
        </div>
        <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasWithBackdrop" aria-controls="offcanvasWithBackdrop"><i
                class="ti-menu"></i>
        </button>
    </nav>
</div>
<div class="p-3">
	{{#each reExam}}
	<div class="card mb-3">
		<div class="card-header bg-transparent">
			<h5 class="text-uppercase text-center mb-3 mt-3">
				<strong>Phiếu tái khám</strong>
			</h5>
			<ul class="nav nav-pills flex-column flex-sm-row" id="pills-tab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="pills-profile-customer-tab" data-bs-toggle="pill"
						data-bs-target="#pills-profile-customer" type="button" role="tab" aria-controls="pills-home"
						aria-selected="true">Thông tin khách hàng</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="pills-counselor-tab" data-bs-toggle="pill"
						data-bs-target="#pills-counselor-{{this._id}}" type="button" role="tab" aria-controls="pills-counselor"
						aria-selected="false">Hình ảnh tư vấn</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="pills-before-tab" data-bs-toggle="pill" data-bs-target="#pills-before-{{this._id}}"
						type="button" role="tab" aria-controls="pills-before" aria-selected="false">Hình ảnh trước
						phẩu</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="pills-after-tab" data-bs-toggle="pill" data-bs-target="#pills-after-{{this._id}}"
						type="button" role="tab" aria-controls="pills-after" aria-selected="false">Hình ảnh sau
						phẩu</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="pills-re-exam-tab" data-bs-toggle="pill" data-bs-target="#pills-re-exam-{{this._id}}"
						type="button" role="tab" aria-controls="pills-after" aria-selected="false">Hình ảnh tái
						khám</button>
				</li>
			</ul>
		</div>
		<div class="card-body">
			<div class="tab-content" id="pills-tabContent">
				<div class="d-flex justify-content-between justify-content-sm-start">
					<label for="status">
						<strong>Ngày hẹn:</strong>&nbsp;
					</label>
					<label class="text-right text-danger"><em>{{formatDate this.schedule}}</em></label>
				</div>
				<div class="d-flex justify-content-between justify-content-sm-start">
					<label for="status">
						<strong>Trạng thái:</strong>&nbsp;
					</label>
					<label class="text-right text-danger"><em>{{this.status}}</em></label>
				</div>
				<div class="d-flex justify-content-between justify-content-sm-start">
					<label for="status">
						<strong>Khách hàng:</strong>&nbsp;
					</label>
					<label class="text-right text-primary">{{this.customerID.firstName}} {{this.customerID.lastName}}</label>
				</div>
				<div class="d-flex justify-content-between justify-content-sm-start">
					<label for="status">
						<strong>Lễ tân:</strong>&nbsp;
					</label>
					<label class="text-right text-primary"><em>{{this.recept.firstName}} {{this.recept.lastName}}</em></label>
				</div>
				<div class="d-flex justify-content-between justify-content-sm-start">
					<label for="status">
						<strong>Dịch vụ đã sử dụng:</strong>&nbsp;
					</label>
					<label class="text-right text-primary"><em>{{this.serviceNoteId.service}}</em></label>
				</div>
				<hr>
				<div class="tab-pane fade show active" id="pills-profile-customer" role="tabpanel"
					aria-labelledby="pills-home-tab">
					<form method="POST" id="submit-re-exam-form">
						<div class="d-flex justify-content-between justify-content-sm-start">
							<label for="status">
								<strong>Bác sĩ:</strong>&nbsp;
							</label>
							<label class="text-right text-primary">
								{{#each this.performer}}
								<input hidden type="text" name="operatingID[]" value="{{this._id}}">
								<em>{{this.firstName}} {{this.lastName}};</em>
								{{/each}}
							</label>
						</div>
						<div class="d-flex justify-content-between justify-content-sm-start">
							<label for="status">
								<strong>Điều dưỡng:</strong>&nbsp;
							</label>
							<label class="text-right text-primary">
								{{#each this.nursing}}
								<input hidden type="text" name="operatingID[]" value="{{this._id}}">
								<em>{{this.firstName}} {{this.lastName}};</em>
								{{/each}}
							</label>
						</div>
						<div class="row">
							<div class="">
								<label for="steps-to-take-area"><strong>Các bước thực hiện</strong></label>
							</div>
							<div class="">
								<textarea style="width: inherit;" class="form-control mr-3 pl-3 bg-white" name="stepsToTake" id="steps-to-take-area" cols="30" rows="8"></textarea>
							</div>
						</div>
					</form>
					<div class="row mt-3">
						<div class="">
							<label for="comments"><strong>Ghi chú:</strong></label>
						</div>
						<div class="">
							{{#if this.comments}}
							{{#each this.comments}}
							<textarea style="width: inherit;" class="form-control mr-3 pl-3 bg-white" id="comments" cols="30" rows="8" disabled>{{this.comment}}</textarea>
							{{/each}}
							{{else}}
							<label class="">
								<em>Không có ghi chú</em>
							</label>
							{{/if}}
						</div>
					</div>
				</div>

				<div class="tab-pane fade" id="pills-counselor-{{this._id}}" role="tabpanel" aria-labelledby="pills-profile-tab">
					<div class="">
						<a data-bs-toggle="collapse" href="#counselor-img-{{this._id}}" role="button" aria-expanded="false" aria-controls="counselor-img">
							Xem ảnh <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="counselor-img-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.counselorImg}}
									{{#each this.serviceNoteId.counselorImg}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<img src="/mnt/vdb/crm.drtuananh.vn/counselor/img/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="...">
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có hình ảnh
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
					<div>
						<a data-bs-toggle="collapse" href="#counselor-video-{{this._id}}" role="button" aria-expanded="false" aria-controls="counselor-video">
							Xem video <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="counselor-video-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.counselorVideo}}
									{{#each this.serviceNoteId.counselorVideo}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<video src="/mnt/vdb/crm.drtuananh.vn/counselor/video/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="..." controls></video>
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có video
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="tab-pane fade" id="pills-before-{{this._id}}" role="tabpanel" aria-labelledby="pills-profile-tab">
					<div>
						<a data-bs-toggle="collapse" href="#before-img-{{this._id}}" role="button" aria-expanded="false" aria-controls="before-img">
							Xem ảnh <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="before-img-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.beforeImg}}
									{{#each this.serviceNoteId.beforeImg}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<img src="/mnt/vdb/crm.drtuananh.vn/before/img/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="...">
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có hình ảnh
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
					<div>
						<a data-bs-toggle="collapse" href="#before-video-{{this._id}}" role="button" aria-expanded="false" aria-controls="before-video">
							Xem video <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="before-video-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.beforeVideo}}
									{{#each this.serviceNoteId.beforeVideo}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<video src="/mnt/vdb/crm.drtuananh.vn/before/video/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="..." controls></video>
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có video
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="tab-pane fade" id="pills-after-{{this._id}}" role="tabpanel" aria-labelledby="pills-profile-tab">
					<div>
						<a data-bs-toggle="collapse" href="#after-img-{{this._id}}" role="button" aria-expanded="false" aria-controls="after-img">
							Xem ảnh <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="after-img-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.afterImg}}
									{{#each this.serviceNoteId.afterImg}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<img src="/mnt/vdb/crm.drtuananh.vn/after/img/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="...">
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có hình ảnh
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
					<div>
						<a data-bs-toggle="collapse" href="#after-video-{{this._id}}" role="button" aria-expanded="false" aria-controls="after-video">
							Xem video <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="after-video-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.serviceNoteId.afterVideo}}
									{{#each this.serviceNoteId.afterVideo}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<video src="/mnt/vdb/crm.drtuananh.vn/after/video/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="..." controls></video>
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có video
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="tab-pane fade" id="pills-re-exam-{{this._id}}" role="tabpanel" aria-labelledby="pills-profile-tab">
					<div>
						<a data-bs-toggle="collapse" href="#re-examination-img-{{this._id}}" role="button" aria-expanded="false" aria-controls="re-examination-img">
							Xem ảnh <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="re-examination-img-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.reExamImg}}
									{{#each this.reExamImg}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<img src="/mnt/vdb/crm.drtuananh.vn/re-examination/img/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="...">
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có hình ảnh
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>
					<div>
						<a data-bs-toggle="collapse" href="#re-examination-video-{{this._id}}" role="button" aria-expanded="false" aria-controls="re-examination-video">
							Xem video <i class="ti-arrow-circle-down"></i>
						</a>
						<div class="collapse mt-3 mb-3" id="re-examination-video-{{this._id}}">
							<div class="card card-body">
								<div class="row">    
									{{#if this.reExamVideo}}
									{{#each this.reExamVideo}}
									<div class="col-xl-2 col-lg-3 col-md-4">
										<figure class="figure imgbox">
											<video src="/mnt/vdb/crm.drtuananh.vn/re-examination/video/{{this}}" class="figure-img img-fluid rounded upd-ava" alt="..." controls></video>
										</figure>
									</div>
									{{/each}}
									{{else}}
									<p class="text-center">
										Chưa có video
									</p>
									{{/if}}
								</div>
							</div>
						</div>
					</div>

					{{!--upload multi re exam --}}

					<form method="POST" action="/operating-room/nursing/re-examination/reexam/{{this._id}}" id="upload-img-re-exam-form" enctype="multipart/form-data">
						<div class="row">
							<input hidden type="text" value="{{this.customerID._id}}" name="customerID">
							<div class="col-sm-6">
								<label for="input-multi-images-before" 
								class="label-avt btn-upload-mobile mt-3">
									<h6>Chọn ảnh tái khám</h6>
								</label>
								<div class="input-images-re-examination mt-2"></div>
							</div>
							<div class="col-sm-6">
								<label for="input-multi-videos-before"
									class="label-avt btn-upload-mobile mt-3">
									<h6>Chọn video tái khám</h6>
								</label>
								<div class="input-videos-re-examination mt-2"></div>
							</div>
						</div>
						{{!-- <div class="row mt-3">
							<input hidden type="text" value="{{this.customerID._id}}" name="customerID">
							<div class="col-sm-6">
								<label id="preview-images-{{this._id}}" for="input-multi-images-re-exam-{{this._id}}" style="width: auto; height: 150px;" class="d-flex justify-content-center border text-center ml-3 mr-3 label-avt btn-upload-mobile mt-4 rounded">
									<h6 id="label-img" class="d-flex align-items-center">Chọn ảnh tái khám</h6>
								</label>
								<input id="input-multi-images-re-exam-{{this._id}}" hidden type="file" name="reExamination" onclick="getIdImg('{{this._id}}')" multiple>
							</div>
							<div class="col-sm-6">
								<label id="preview-videos-{{this._id}}" for="input-multi-videos-re-exam-{{this._id}}" style="width: auto; height: 150px;" class="d-flex justify-content-center border text-center ml-3 mr-3 label-avt btn-upload-mobile mt-4 rounded">
									<h6 id="label-video" class="d-flex align-items-center">Chọn video tái khám</h6>
								</label>
								<input id="input-multi-videos-re-exam-{{this._id}}" hidden type="file" name="reExamination" onclick="getIdVideo('{{this._id}}')" multiple>
							</div>
						</div> --}}
						<div class=" d-flex justify-content-center mt-4">
							<button type="submit" class="btn btn-primary btn-upload-mobile" data-bs-toggle="modal"
								data-bs-target="#re-exam-modal" data-re-exam-id="{{this._id}}">Tải lên</button>
						</div>
					</form>
				</div>
			</div>

			<div class="d-flex justify-content-between justify-content-sm-end mt-3">
				<label for="status">
					<strong>Phí dịch vụ:</strong>&nbsp;
				</label>
				<label class="text-danger text-right">
					{{#if this.price}}
					{{this.price}} VND
					{{else}}
					0 VND
					{{/if}}
				</label>
			</div>
		</div>
		<div class="card-footer bg-transparent d-flex justify-content-end">
			<button type="button" data-bs-toggle="modal" data-bs-target="#submit-re-exam-modal"
				class="btn btn-success btn-mobile" data-id="{{this._id}}">Hoàn thành</button>
		</div>
	</div>
	{{else}}
	<div class="text-center">Chưa có dịch vụ cần thực hiện.</div>
	{{/each}}
</div>
{{!-- Complete re-exam --}}
<div class="modal fade" id="submit-re-exam-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">Hoàn thành</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				Đã hoàn thành dịch vụ
			</div>
			<div class="modal-footer">
				<button id="submit-form-re-exam-btn" type="button" class="btn btn-danger">Đã hoàn
					thành</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>

			</div>
		</div>
	</div>
</div>
<script src="/js/operating/nursing-re-exam.js"></script>
<script>
	function getIdImg(id) {
		console.log('id', id);
		let chosenImg = document.querySelector(`#input-multi-images-re-exam-${id}`);
		chosenImg.addEventListener('change', (e) => {
			let filesImg = e.target.files;
			let outputImage = document.getElementById(`preview-images-${id}`);
			for (i = 0; i < filesImg.length; i++) {
				let fileImg = filesImg[i];
				let picReaderImg = new FileReader();
				if (fileImg.type === 'image/png') {
					picReaderImg.addEventListener('load', (e) => {
						let picFileImg = e.target;
						let labelImage = document.getElementById('label-img').hidden = true;
						let figureImg = document.createElement("figure");
						let closeBtnImg = document.createElement('button');
						closeBtnImg.setAttribute('class', 'btn-close btn-close-white');
						closeBtnImg.setAttribute('type', 'button');
						closeBtnImg.setAttribute('aria-label', 'Close');
						figureImg.setAttribute('class', 'figure imgbox')
						figureImg.innerHTML = "<img class='figure-img img-fluid rounded upd-ava' src='" + picFileImg.result + "'" + "title='" + picFileImg.name + "'/><button class='btn-close btn-close-white' type='button' aria-label='Close'></button>";
						// figure.innerHTML = "<button class='btn-close btn-close-white' type='button' aria-label='Close'></button>"
						outputImage.insertBefore(figureImg, null);
					});
					picReaderImg.readAsDataURL(fileImg);
				}
			}
		})
	}
	function getIdVideo(id) {
		console.log('id', id);
		let chosenVideo = document.querySelector(`#input-multi-videos-re-exam-${id}`);
		chosenVideo.addEventListener('change', (e) => {
			let filesVideo = e.target.files;
			let outputVideo = document.getElementById(`preview-videos-${id}`);
			console.log('files', filesVideo)
			for (i = 0; i < filesVideo.length; i++) {
				let fileVideo = filesVideo[i];
				let picReaderVideo = new FileReader();
				if (fileVideo.type === 'video/mp4') {
					console.log('dung')
					picReaderVideo.addEventListener('load', (e) => {
						let picFileVideo = e.target;
						let figureVideo = document.createElement("figure");
						figureVideo.setAttribute('class', 'figure imgbox')
						figureVideo.innerHTML = "<video class='figure-img img-fluid rounded upd-ava' src='" + picFileVideo.result + "'" + "title='" + picFileVideo.name + "' controls/>";
						outputVideo.insertBefore(figureVideo, null);
					});
					picReaderVideo.readAsDataURL(fileVideo);
				}
			}
		})
	}
	
</script>